<template >
  <div class="user-register" >

    <div class="input-bar" >
      <div class="phone-num-box" >
        <cube-input
          class="input-phone-num"
          v-model="phoneNum.value"
          :placeholder="phoneNum.placeholder"
          :type="phoneNum.type"
          :maxlength="phoneNum.maxlength"
          :readonly="phoneNum.readonly"
          :disabled="phoneNum.disabled"
          :autofocus="phoneNum.autofocus"
          :autocomplete="phoneNum.autocomplete"
          :clearable="phoneNum.clearable"
          @input="_inputPhone()"
        ></cube-input >
      </div >
      <div class="phone-code-box" >
        <cube-input
          class="input-phone-code"
          v-model="phoneCode.value"
          :placeholder="phoneCode.placeholder"
          :type="phoneCode.type"
          :maxlength="phoneCode.maxlength"
          :readonly="phoneCode.readonly"
          :disabled="phoneCode.disabled"
          :autofocus="phoneCode.autofocus"
          :autocomplete="phoneCode.autocomplete"
          :clearable="phoneCode.clearable"
          :eye="phoneCode.eye"
          @input="_inputCode()"
        ></cube-input >
        <div class="get-code-btn" :class="getCodeDisable?'disable':''" >
          <span v-show="!isCountDown" @click="getCode()" >获取验证码</span >
          <span v-show="isCountDown" >{{timeLimit - secondNumber}}秒后重新获取</span >
        </div >
      </div >
    </div >

    <div class="btn-bar" >
      <ripple-btn class="next-btn" :class="nextBtnDisable?'disable':''" v-on:click.native="checkCode()" >
        下一步
      </ripple-btn >
    </div >
    
    <p class="tips-text" @click="showProtocol(true)" >*注册则代表同意 <span >《乐都城网络服务协议》</span > </p >
    <!--协议 -begin -->
    <transition name="slideUp" >
      <div class="protocol-wrap" v-show="isShowProtocol" >
        
        <div class="top-bar" >
          <div class="back-btn" @click="showProtocol(false)" ></div >
          <div class="protocol-title" >服务协议</div >
          <div class="empty" ></div >
        </div >
        
        <div class="protocol-con" >
          <p >以下是乐都城网（http://www.musicdo.cn）为您提供服务的条款。本协议详述您在http://www.musicdo（"网站"）使用我们的服务所必须遵守的条款和条件。</p >
          <p >请在注册前认真阅读以下服务协议，一旦您注册成为乐都城网会员用户，就表示您已经阅读、同意并接受本用户协议中所含的所有条款和条件。如果无法接受乐都城网任意一条规定或者对规定存有质疑，请不要进行注册。如您有任何疑问，请及时联系我们。</p >
          <p >一、本服务协议双方为乐都城网与乐都城网会员用户（以下简称“用户”），本服务协议具有合同效力。</p >
          <p >1．本服务协议内容包括协议正文及所有乐都城网已经发布的或将来可能发布的各类规则。所有规则为协议不可分割的一部分，与协议正文具有同等法律效力。无论用户事实上是否在注册之前认真阅读了本服务协议，只要用户按照乐都城网注册程序成功注册为用户，用户的行为表示同意并签署了本服务协议。</p >
          <p >2．本服务协议的效力范围及于乐都城网站的一切产品和服务，用户在使用乐都城网提供的任何单项服务的同时，用户的使用行为视为其对该单项服务的相关规定以及乐都城网在该单项服务中发出的各类公告的同意。</p >
          <p >3．乐都城网有权根据需要不时的制定、修改本协议或各类规则，如有任何变更，乐都城网将在网站上刊载公告通知用户，用户在享受单项服务时，应当及时查阅了解修改的内容，并自觉遵守本服务协议以及该单项服务的相关规定。如用户不同意相关变更，必须停止使用服务，经修订的协议一经在乐都城网公布后，立即自动生效，各类规则会在发布后生效，亦成为本协议的一部分，登录或继续使用服务将表示用户接受经修订的协议。除另行明确声明外，任何使服务范围扩大或功能增强的新内容均受本协议约束。</p >
          <p >4．本协议不涉及用户与乐都城网其它用户之间产生的法律关系及法律纠纷。</p >
          <p >二、定义及其一般规定：</p >
          <p >1．有关乐都城网站中的术语或图标的含义，详见乐都城帮助。</p >
          <p >2．用户必须是具备完全民事行为能力的自然人，无民事行为能力人、限制民事行为能力人不允许注册为乐都城网用户，其与乐都城网之间的服务协议自始无效，乐都城网一经发现，有权立即注销该用户，并追究其使用乐都城网服务的一切法律责任。</p >
          <p >3．用户注册是指用户登录乐都城网，并按要求填写相关信息并确认相关用户协议的过程。</p >
          <p >三、用户权利和义务：</p >
          <p >1．用户注册成功后，将在乐都城网拥有自己的用户名及密码，用户有权利使用自己的用户名及密码随时登录乐都城网。用户不得以任何形式擅自转让或授权他人使用自己的乐都城网用户名，如果用户未保管好自己的用户名和密码而对用户本人、乐都城网或第三方造成的损害，将由用户承担全部责任，每位用户都要对其拥有的用户名进行的所有活动和事件负全责。用户同意若发现任何非法使用用户名或安全漏洞的情况，立即通告乐都城网。</p >
          <p >2．用户有权根据本服务协议的规定以及乐都城网网上发布的相关规则，在乐都城网查询各类信息、参加网上商品购买、使用乐都城网社区功能，参加乐都城网的有关活动以及有权享受乐都城网提供的其他有关信息服务。</p >
          <p >3．用户必须在注册时提供自己的真实资料，并保证诸如电子邮件地址、联系电话、手机、联系地址、邮政编码等内容的有效性及安全性，保证乐都城网可以通过上述联系方式与自己进行联系，并将对用户在订单中提供的所有信息的真实性负责。同时，用户有义务在相关资料发生变更时及时更新有关注册资料。用户保证不以他人资料在乐都城网进行注册或认证。</p >
          <p >4.用户在下订单时，请仔细查询“商品信息中详细的尺寸说明”，选择适合自己的尺寸后再确认订单，如果顾客在收货后发现尺寸问题，公司即不予退货，但可以在7天之内予以换货。</p >
          <p >5.在购买乐都城网物品物品时，用户有义务完成与乐都城网的交易，但法律或本用户协议禁止的交易除外。通过对一项物品的下订单，用户同意受该物品描述所含的出售条件的约束，只要该等出售条件不违反本协议或不是非法的。</p >
          <p >6．本着尊重他人也是尊重自己的原则，用户禁止注册党和国家领导人或其他名人之名；国家机构或其他机构的名称；名人的真实姓名、字号、艺名、笔名；与其他网友之名相近、相仿的名字；不文明、不健康的用户名。</p >
          <p >7．用户应当保证在乐都城网进行商品购买过程中遵守诚实信用的原则，不扰乱网上商品购买的正常秩序。</p >
          <p >8．用户在乐都城网上不得发布各类违法或违规信息。</p >
          <p >9．用户承诺自己在乐都城网上的所有行为遵守国家法律、法规和乐都城网的相关规定，对于任何法律后果的发生，用户将以自己的名义独立承担所有相应的法律责任。</p >
          <p >10．用户承诺不对乐都城网任何资料作商业性利用，包括但不限于在未经乐都城网事先书面批准的情况下，复制乐都城网网站上展示的任何资料，不能利用乐都城网各项服务进行销售或其它商业用途。</p >
          <p >11．用户承诺在乐都城网上不进行任何破坏网站安全的操作，包括但不限于企图干涉、破坏网站的正常运行；未经许可使用网站数据或进入未经许可的服务器、帐户等；未经乐都城网许可，企图探查、扫描、测试系统或网络的弱点或其它实施破坏网络安全的行为；发送促销产品的广告及服务内容的电子邮件；伪造TCP/IP数据包名称或部分名称。</p >
          <p >12．用户使用乐都城网任何服务时将承担一定风险，乐都城网不承担由于用户自身过错、技术或其它不可控原因导致的网站页面信息或其它方面的错误而给用户造成的损失，除非现行的法律法规另有明文规定。</p >
          <p >13．用户同意接收来自乐都城网的信息。</p >
          <p >四、乐都城网的权利和义务：</p >
          <p >1．乐都城网有义务在现有技术上确保整个网站的正常运行，并努力提升和改进技术，保证用户使用乐都城网服务的顺利。</p >
          <p >2．对用户在注册使用乐都城网服务中所遇到有关问题及用户反映的情况，乐都城网有义务及时作出回复。</p >
          <p >3.乐都城网提供的物品质量，有国家标准或专业标准的，按国家标准或专业标准执行；无前述标准的，按生产厂的企业标准执行；无生产厂企业标准的，由用户与乐都城网协商确定。如果物品质量不符合标准，用户可以要求换货或退货。</p >
          <p >4.乐都城网网站上的广告，价目表和声明并不构成要约。在乐都城网向用户发送电子邮件确认处理用户的订单之前，用户和乐都城网之间不存在合同关系。乐都城网有权在发现了乐都城网网站上显现的产品及订单的明显错误或缺货的情况下，单方面撤回该信息或撤销合同。乐都城网保留对产品订购的数量的限制权。</p >
          <p >5．产品价格和可获性都会在网站上指明。这类信息将随时更改且不发任何通知。每一项显示的价格都包含了增值税（按照中国的标准税率）。送货费将另外结算，费用根据拥护选择的送货方式的不同而异。如果发生了意外情况，在收到用户的订单后，由于供应商提价，税额变化引起的价格变化，或是由于网站的错误等造成价格变化，乐都城网会通过email或电话通知用户，在乐都城网没有取消订单的情况下，让用户决定是否取消订单。</p >
          <p >6．所有权和风险，产品所有权和风险在产品交付买方或其指定收货人时转移给买方。</p >
          <p >7．用户提供给乐都城网个人信息时，乐都城网会采取合理的步骤保护用户的个人信息，乐都城网也会采取合理的安全手段保护存储的个人信息。除非根据法律或政府的强制性规定，在未得到用户许可之前乐都城平网不会把用户的任何个人信息提供给无关的任何第三方（包括公司或个人）。</p >
          <p >8．乐都城网有权对用户的注册资料及操作行为进行查阅，发现注册资料或操作行为中存在任何问题或怀疑，均有权向用户发出询问及要求改正的通知或者直接作出删除等处理。</p >
          <p >9．对于在乐都城网上的违法行为、不当行为或其它任何乐都城网认为应当终止服务的情况，乐都城网有权随时作出删除相关信息、终止服务等处理，而无须征得用户的同意，并协助司法机关，将此类行为提交诉讼，导致乐都城网损失的，乐都城网有权要求索赔。</p >
          <p >10．经国家生效法律文书或行政处罚决定确认用户存在违法行为，或者乐都城网有足够事实依据可以认定用户存在违法或违反服务协议行为的，乐都城网有权在乐都城网网站上以网络发布形式公布用户的违法行为。</p >
          <p >11．对于用户在乐都城网发布的下列各类信息，乐都城网有权在不通知用户的前提下进行删除或采取其他限制性措施，包括但不限于乐都城网有足够理由相信存在欺诈等恶意或虚假成份；乐都城网有足够理由相信存在试图扰乱正常网上秩序因素；乐都城网有足够理由相信该信息违反公共利益或可能严重损害乐都城网和其他用户合法利益的；危害国家安全、国家统一、社会安定的信息；诽谤、淫秽、威胁、辱骂或其他侵害他人身份权利的信息。</p >
          <p >12．乐都城网所提供的网络服务的所有内容，如文字、图片、图像、视频、软件等都是本公司财产以及与乐都城网站相关著作权、专利权、商标、商业秘密及其它任何所有权或权利，均属乐都城网所有。非经乐都城网的同意，任何人或用户均不得擅自下载、复制、传输、改编、编辑，否则应负所有法律责任。乐都城网拥有向用户提供网络服务过程中所产生并储存于乐都城网服务器中的任何数据信息的所有权。违反上述声明而给本公司造成损失的，本公司将依法追究其法律责任。</p >
          <p >五、服务的中断和终止：</p >
          <p >1．用户同意，在乐都城网未收取会员服务费的情况下，乐都城网可自行全权决定以任何理由 (包括但不限于乐都城网认为您已违反本协议的字面意义和精神，或以不符合本协议的字面意义和精神的方式行事，或您在超过60天的时间内未以您的用户名及密码登录网站) 终止用户的用户名进行登录或停止用户使用乐都城网的任何服务，并删除和丢弃用户在使用乐都城网服务中提交的用户资料。同时乐都城网可自行全权决定，在发出通知或不发出通知的情况下，随时停止提供服务或其任何部份。账号终止后，乐都城网没有义务为用户保留原帐号中或与之相关的任何信息，或转发任何未曾阅读或发送的信息给用户或第三方。此外，用户同意，乐都城网不会就终止为用户提供服务而对用户或任何第三者承担任何责任。</p >
          <p >2．用户向乐都城网提出注销乐都城网注册用户身份，经乐都城网审核同意，由乐都城网注销注册用户，用户即解除与乐都城网的服务协议关系。但注销用户后，乐都城网仍保留下列权利：</p >
          <p >A．用户注销后，乐都城网有权保留用户的注册资料及以前的操作行为记录；</p >
          <p >B．用户注销后，如用户注销前在乐都城网上存在违法行为或违反协议的行为，乐都城网仍可行使本服务协议所规定的权利。</p >
          <p >3．在下列情况下，乐都城网可以通过注销用户的方式终止服务：</p >
          <p >A．用户因违反本服务协议相关规定而被乐都城网中断服务，乐都城网将在中断服务时通知用户。但用户被终止服务后，再一次或以他人名义注册为乐都城网用户的，乐都城网可以单方面终止与该用户的服务协议；</p >
          <p >B．乐都城网在与用户联系过程中，发现用户注册时填写的电子邮箱不存在或无法接收电子邮件的，经乐都城网以其他联系方式通知用户更改，而用户在三个工作日内仍未提供新的电子邮箱地址的，乐都城网可以终止与该用户的服务协议；</p >
          <p >C．一旦乐都城网发现用户注册资料中主要内容是虚假的，乐都城网可以随时终止与该用户的服务协议；</p >
          <p >D．本服务协议终止或更新时，用户未确认新的服务协议的；</p >
          <p >E、通过盗取密码、诈骗等不正当手段获得会员账号的行为。</p >
          <p >F、不遵守本站的交易政策。</p >
          <p >G．其它乐都城网认为需终止服务的情况。</p >
        </div >
      
      </div >
    </transition >
    <!--协议 -end -->
    
  </div >
</template >

<script type="text/ecmascript-6" >
import {
  getVerificationCode,
  checkVerificationCode,
  checkCodeAndPhoneNumber
} from 'api/verificationCode'
import RippleBtn from 'base/ripple-btn/ripple-btn'
export default {
  // 别名
  name: 'UserRegister',
  // 数据
  data () {
    return {
      phoneNum: {
        value: '',
        placeholder: '请输入手机号码',
        type: 'number',
        readonly: false,
        maxlength: 16,
        disabled: false,
        autofocus: true,
        autocomplete: true,
        clearable: true
      },
      phoneCode: {
        value: '',
        placeholder: '请输入验证码',
        type: 'number',
        readonly: false,
        maxlength: 6,
        disabled: true,
        autofocus: false,
        autocomplete: false,
        clearable: true
      },
      getCodeDisable: true, // 初始获取验证码按钮是否禁止
      nextBtnDisable: true, // 初始下一步按钮是否禁止
      truePhoneNumber: '', // 获取验证码的手机号
      timeLimit: 10, // 倒计时秒数限制
      secondNumber: 0, // 倒计时时间
      isCountDown: false, // 是否在倒计时
      errEvent: 'DEFAULT', // 用于判断弹框的确定事件
      isShowProtocol: false
    }
  },
  // 子组件
  components: {
    RippleBtn
  },
  // 接受父组件传递数据
  props: {},
  // 组件实例创建前
  beforeCreate () {},
  // 组件实例创建后
  created () {},
  // 模板编译/挂载前
  beforeMount () {},
  // 模板编译/挂载后
  mounted () {},
  // 组件更新前
  beforeUpdate () {},
  // 组件更新后
  updated () {},
  // 组件销毁前
  beforeDestroy () {},
  // 组件销毁后
  destroyed () {},
  // 方法集合
  methods: {
    _getVerificationCode (params) {
      console.log('params', params)
      let oParams = Object.assign({}, {
        phoneNumber: this.phoneNum.value,
        actionType: 'register'
      }, params)
      getVerificationCode(oParams).then((res) => {
        console.log('res', res)
        //        console.log('Flag', res.Flag)
        //        console.log('Code', res.Code)
        //        console.log('Message', res.Message)
        // Code 返回结果 -- 0：失败、1：成功
        if (res.Code === 0) {
          console.log('验证码获取失败')
          console.log('Code-0', res.Code)
          this.errEvent = 'GET_CODE_ERR_0'
          let errText = {
            title: '验证码获取失败',
            content: '请检查手机号码是否有误'
          }
          this.codeError(errText)
        } else if (res.Code === 1) {
          console.log('验证码获取成功')
          console.log('Code-1', res.Code)
          this.errEvent = 'DEFAULT'
          this.truePhoneNumber = oParams.phoneNumber
          this.countDown() // 开始倒计时
        } else {
          this.errEvent = 'DEFAULT'
          console.log('Code', res.Code)
        }
      })
    },
    _checkVerificationCode (params) {
      let oParams = Object.assign({}, {
        phoneNumber: this.truePhoneNumber,
        code: this.phoneCode.value,
        actionType: 'register'
      }, params)
      checkVerificationCode(oParams).then((res) => {
        console.log('checkVerificationCode-res', res)
        console.log('checkVerificationCode-Flag', res.Flag)
        console.log('checkVerificationCode-Code', res.Code)
        // Code 返回结果 -- 0：失败、1：成功(未确定)
        console.log('checkVerificationCode-Message', res.Message)
        if (res.Code === 0) {
          console.log('000')
          console.log('验证失败')
          this.errEvent = 'CHECK_CODE_ERR_0'
          let errText = {
            title: '验证失败',
            content: '请检查手机号码是否有误'
          }
          this.codeError(errText)
          return false
        } else if (res.Code === 1) {
          console.log('111')
          console.log('验证成功')
          this.errEvent = 'DEFAULT'
          this._checkCodeAndPhoneNumber(params)
          return true
        } else {
          console.log(res.Code)
          this.errEvent = 'DEFAULT'
          return false
        }
      })
    },
    _checkCodeAndPhoneNumber (params) {
      let oParams = Object.assign({}, {
        phoneNumber: this.truePhoneNumber,
        code: this.phoneCode.value,
        actionType: 'register'
      }, params)
      checkCodeAndPhoneNumber(oParams).then((res) => {
        console.log('checkCodeAndPhoneNumber-res', res)
        console.log('checkCodeAndPhoneNumber-Flag', res.Flag)
        console.log('checkCodeAndPhoneNumber-Code', res.Code)
        // Code 返回结果 -- 0：该手机号码已注册、1：该手机号码可以注册、2、验证码不正确
        console.log('checkCodeAndPhoneNumber-Message', res.Message)
        if (res.Code === 0) {
          console.log('该手机号码已注册')
          this.errEvent = 'CHECK_CODE_AND_PHONE_ERR_0'
          this.codeError({
            title: '该手机号码已注册',
            content: '请重新登陆',
            confirmBtnText: '前往登陆'
          })
        } else if (res.Code === 1) {
          console.log('该手机号码可以注册')
          console.log('跳转下一页，进行密码设置')
          this.errEvent = 'DEFAULT'
          this.$router.push({
            path: '/user-register-set-password',
            query: {
              phoneNumber: this.truePhoneNumber
            }
          })
        } else if (res.Code === 2) {
          console.log('验证码不正确')
          this.errEvent = 'CHECK_CODE_AND_PHONE_ERR_2'
          let errText = {
            title: '验证码不正确',
            content: '请输入正确的验证码'
          }
          this.codeError(errText)
        } else {
          this.errEvent = 'DEFAULT'
          console.log(res.Code)
        }
      })
    },
    _inputPhone () {
      if (this.phoneNum.value.length === 11) {
        console.log('长度为11，才开启获取验证码按钮与验证码输入框')
        this.getCodeDisable = false
        this.phoneCode.disabled = false
      } else {
        this.getCodeDisable = true
        this.phoneCode.disabled = true
      }
    },
    _inputCode () {
      this.isNextBtnDisable()
    },
    isNextBtnDisable () {
      console.log('验证码输入中，判断两个输入框是否有值，有值就开启下一步按钮，没值就禁用下一步按钮')
      if (this.phoneCode.value !== '' && this.phoneNum.value !== '') {
        this.nextBtnDisable = false
      } else {
        this.nextBtnDisable = true
      }
    },
    getCode () {
      if (this.getCodeDisable === false) { // 当获取验证码按钮为非禁用状态时
        this._getVerificationCode() // 获取验证码
      } else {
        return false
      }
    },
    checkCode () {
      if (this.nextBtnDisable === false) { // 当下一步按钮为非禁用状态时
        this._checkVerificationCode()
      } else {
        return false
      }
    },
    codeError (config) {
      this.$createDialog({
        type: 'confirm',
        //          icon: 'cubeic-alert',
        title: config.title || '验证码错误',
        content: config.content || '请重新注册',
        confirmBtn: {
          text: config.confirmBtnText || '重新注册',
          active: true,
          disabled: false,
          href: 'javascript:;'
        },
        cancelBtn: {
          text: '取消',
          active: false,
          disabled: false,
          href: 'javascript:;'
        },
        onConfirm: () => {
          console.log('点击了重新注册按钮，这里写重新注册逻辑')
          console.log(this.errEvent)
          if (this.errEvent === 'GET_CODE_ERR_0' ||
            this.errEvent === 'CHECK_CODE_ERR_0' ||
            this.errEvent === 'CHECK_CODE_AND_PHONE_ERR_2' ||
            this.errEvent === 'DEFAULT') {
            console.log('获取验证码失败，请重新注册')
            this.resetInputVal()
          } else if (this.errEvent === 'CHECK_CODE_AND_PHONE_ERR_0') {
            console.log('该手机号码已注册，请重新登录')
            this.$router.push({
              path: '/user-login'
            })
          } else {
            console.log('获取验证码失败，请重新注册')
            this.resetInputVal()
          }
        },
        onCancel: () => {
          console.log('点击了取消按钮，这里返回false即可')
          return false
        }
      }).show()
    },
    resetInputVal () {
      this.phoneNum.value = ''
      this.phoneCode.value = ''
      this.truePhoneNumber = ''
    },
    countDown () {
      this.secondNumber = 0 // 重置为0再开始
      let countDownTimer = null // 存倒计时定时器
      this.getCodeDisable = true // 重置获取验证码按钮为禁用状态
      this.isCountDown = true // 设置为正在倒计时状态
      clearInterval(countDownTimer) // 先清除一次
      countDownTimer = setInterval(() => {
        this.secondNumber++ // 每秒加1
        if (this.secondNumber === this.timeLimit) { // 当倒数秒数与限制时间相等时
          this.getCodeDisable = false // 获取验证码按钮为启用状态
          this.isCountDown = false // 不在倒计时状态
          clearInterval(countDownTimer) // 清除倒计时
        } else {
          this.getCodeDisable = true // 正在倒计时，获取验证码按钮为禁用状态
          this.isCountDown = true // 正在倒计时
        }
      }, 1000)
    },
    showProtocol (flag) {
      this.isShowProtocol = flag
    }
  },
  // 实时计算数据（一个数据受多个数据影响）
  computed: {},
  // 实时计算数据（一个数据影响多个数据）
  watch: {}
}
</script >

<style lang="stylus" rel="stylesheet/stylus" >
@import 'user-register.styl'
</style >
